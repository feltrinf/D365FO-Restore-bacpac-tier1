{"tasks":[{"environment":{},"displayName":"Get-LcsDatabaseLatestBackup","alwaysRun":false,"continueOnError":false,"condition":"succeeded()","enabled":true,"timeoutInMinutes":0,"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"#region variables\n$url = ('{0}/{1}/databases/project/{2}' -f \"$(LcsApiUri)\", \"$(DATABASEMOVEMENTENDPOINT)\", \"$(projectId)\")\n\n$token=\"$(access_token)\"\n$name=\"$(prefix_bacpacfile)\"\n\n$header = @{\n    Authorization = \"Bearer $token\"\n   \"x-ms-version\"=\"$(x-ms-version)\"   \n}\n#end region \n\n$fileLocation=[string]::Empty\n$filename=[string]::Empty\n$name=[string]::Empty\n\ntry\n{\n    $response = Invoke-RestMethod $url -Method Get -ContentType  \"application/json\" -Headers $header\n    $isSuccess=$response.isSuccess    \n\n    if($isSuccess -eq $true)\n    {\n        $backups = ($response.DatabaseAssets | Where-Object {$_.name -like \"*$name*\"} | Sort-Object -Property CreatedDateTime -Descending)\n        if($backups)\n        { \n            $fileLocation=$backups[0].FileLocation\n            $filename=$backups[0].FileName \n            $name=$backups[0].Name                     \n        }\n    }\n    \n}\ncatch\n{\n    $isSuccess=$false    \n\n    Write-Host \"Failed to trigger request {$url}, Exception: $_\" -ForegroundColor Red\n}\n\nWrite-Host \"##vso[task.setvariable variable=isSuccess]$isSuccess\"\nWrite-Host \"##vso[task.setvariable variable=fileLocation]$fileLocation\"\nWrite-Host \"##vso[task.setvariable variable=filename]$filename\"\nWrite-Host \"##vso[task.setvariable variable=name]$name\"\n\nreturn $fileLocation","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":""},"task":{"id":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","versionSpec":"2.*","definitionType":"task"}}],"runsOn":["Agent","DeploymentGroup"],"revision":8,"createdBy":{"displayName":"Francesco Feltrin","id":"6671c05e-8b0e-6a74-9e5d-a2c2dc2afa6e","uniqueName":"francesco.feltrin@cegeka.it"},"createdOn":"2020-05-09T15:03:26.767Z","modifiedBy":{"displayName":"Francesco Feltrin","id":"6671c05e-8b0e-6a74-9e5d-a2c2dc2afa6e","uniqueName":"francesco.feltrin@cegeka.it"},"modifiedOn":"2020-05-10T12:43:59.790Z","comment":"","id":"08d0f3a5-9980-4a46-b501-7dca84ddf158","name":"cgkGet-LcsDatabaseLatestBackup","version":{"major":1,"minor":0,"patch":0,"isTest":false},"iconUrl":"https://cdn.vsassets.io/v/M168_20200506.1/_content/icon-meta-task.png","friendlyName":"cgkGet-LcsDatabaseLatestBackup","description":"Get latest backup with specified prefix name\nhttps://docs.microsoft.com/en-us/dynamics365/fin-ops-core/dev-itpro/database/api/v1/reference-list-backups","category":"Utility","definitionType":"metaTask","author":"Francesco Feltrin","demands":[],"groups":[],"inputs":[{"aliases":[],"options":{},"properties":{},"name":"access_token","label":"access_token","defaultValue":"$(access_token)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"DATABASEMOVEMENTENDPOINT","label":"DATABASEMOVEMENTENDPOINT","defaultValue":"$(databaseMovementEndpoint)","required":true,"type":"string","helpMarkDown":"databasemovement/v1","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"LcsApiUri","label":"LcsApiUri","defaultValue":"$(LcsApiUri)","required":true,"type":"string","helpMarkDown":"https://lcsapi.lcs.dynamics.com","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"prefix_bacpacfile","label":"prefix_bacpacfile","defaultValue":"$(prefix_bacpacfile)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"projectId","label":"projectId","defaultValue":"$(projectId)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"x-ms-version","label":"x-ms-version","defaultValue":"$(x-ms-version)","required":true,"type":"string","helpMarkDown":"","groupName":""}],"satisfies":[],"sourceDefinitions":[],"dataSourceBindings":[],"instanceNameFormat":"Task group: cgkGet-LcsDatabaseLatestBackup $(access_token)","preJobExecution":{},"execution":{},"postJobExecution":{}}