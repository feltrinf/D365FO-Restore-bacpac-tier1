{"tasks":[{"environment":{},"displayName":"AzCopyTransfer-bacpac","alwaysRun":false,"continueOnError":false,"condition":"eq(variables['isSuccess'], True)","enabled":true,"timeoutInMinutes":0,"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"function validate-staging-dir()\n{\n    $localTemporaryStorage = \"$(stagingDirectory)\"\n    Write-Host \"Staging directory: $localTemporaryStorage\"\n\n    if(Test-Path $localTemporaryStorage -PathType Container)\n    {\n        if($localTemporaryStorage.Substring($localTemporaryStorage.Length-1,1) -ne \"\\\")\n        {\n            $localTemporaryStorage = $localTemporaryStorage + \"\\\"\n        }\n    }\n    else \n    {\n        Write-Host \"This is not a folder!\"\n        $localTemporaryStorage =[string]::Empty\n    }\n\n    return $localTemporaryStorage \n}\n\n\nfunction install-azcopy()\n{\n    try\n    {\n        #download AzCopy\n        Invoke-WebRequest -Uri \"https://aka.ms/downloadazcopy-v10-windows\" -OutFile AzCopy.zip -UseBasicParsing\n\n        #unblock and Expand Archive\n        Unblock-File ./AzCopy.zip\n\n        Expand-Archive ./AzCopy.zip ./AzCopy -Force\n\n        #move AzCopy to the destination you want to store it\n        $destinationFolder=\"$($env:PIPELINE_WORKSPACE)\" +\"\\Bin\"\n        $destinationFilePath=$destinationFolder + \"\\AzCopy.exe\"\n\n        Get-ChildItem ./AzCopy/*/azcopy.exe | Move-Item -Destination \"$destinationFilePath\"\n    }\n    catch\n    {\n        Write-Host \"Failed to trigger request, Exception: $_\" -ForegroundColor Red\n        $destinationFilePath=[string]::Empty\n    }\n\n    return $destinationFilePath\n}\n\n\n\n$fileName = \"$(filename)\"\nWrite-Host \"Filename: $fileName\"\n\n$fileLocation = \"$(fileLocation)\"\nWrite-Host \"File location: $fileLocation\"\n\n$localTemporaryStorage = validate-staging-dir\n\nif($localTemporaryStorage)\n{\n    $filenamePath = $localTemporaryStorage + $fileName\n    Write-Host $filenamePath\n\n    try \n    {\n        Invoke-D365InstallAzCopy\n        Invoke-D365AzCopyTransfer -SourceUri \"$fileLocation\" -DestinationUri \"$filenamePath\" -Force   \n        $isSuccess = $true                     \n    }\n    catch\n    {\n        Write-Host \"Failed to trigger request, Exception: $_\" -ForegroundColor Red\n        $isSuccess = $False\n        $filenamePath=[string]::Empty\n    }\n}\n  \nWrite-Host \"##vso[task.setvariable variable=isSuccess]$isSuccess\"\nWrite-Host \"##vso[task.setvariable variable=filenamePath]$filenamePath\"\n\nreturn $filenamePath\n\n\n\n\n","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":""},"task":{"id":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","versionSpec":"2.*","definitionType":"task"}}],"runsOn":["Agent","DeploymentGroup"],"revision":24,"createdBy":{"displayName":"Francesco Feltrin","id":"6671c05e-8b0e-6a74-9e5d-a2c2dc2afa6e","uniqueName":"francesco.feltrin@cegeka.it"},"createdOn":"2020-05-09T15:19:47.460Z","modifiedBy":{"displayName":"Francesco Feltrin","id":"6671c05e-8b0e-6a74-9e5d-a2c2dc2afa6e","uniqueName":"francesco.feltrin@cegeka.it"},"modifiedOn":"2020-05-10T12:38:59.700Z","comment":"","id":"ed2389c2-6540-438f-8e3a-903ab5a2aefe","name":"cgkAZCopyTransfer-bacpac","version":{"major":1,"minor":0,"patch":0,"isTest":false},"iconUrl":"https://cdn.vsassets.io/v/M168_20200506.1/_content/icon-meta-task.png","friendlyName":"cgkAZCopyTransfer-bacpac","description":"download pacpac to stagingDirectory","category":"Utility","definitionType":"metaTask","author":"Francesco Feltrin","demands":[],"groups":[],"inputs":[{"aliases":[],"options":{},"properties":{},"name":"$env:PIPELINE_WORKSPACE","label":"$env:PIPELINE_WORKSPACE","defaultValue":"$($env:PIPELINE_WORKSPACE)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"fileLocation","label":"fileLocation","defaultValue":"$(fileLocation)","required":true,"type":"string","helpMarkDown":"blob file location","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"filename","label":"filename","defaultValue":"$(filename)","required":true,"type":"string","helpMarkDown":"bacpac filename","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"stagingDirectory","label":"stagingDirectory","defaultValue":"$(stagingDirectory)","required":true,"type":"string","helpMarkDown":"local download path","groupName":""}],"satisfies":[],"sourceDefinitions":[],"dataSourceBindings":[],"instanceNameFormat":"Task group: cgkAZCopyTransfer-bacpac $($env:PIPELINE_WORKSPACE)","preJobExecution":{},"execution":{},"postJobExecution":{}}